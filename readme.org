#+title: K8s infra

Initial setup for a complete K8s setup.

#+begin_src bash :exports both :results raw
echo -n '[[http://'
make ENV=prod kubectl-loadBalancer-ip
echo '][Public IP of this load balancer]]'
#+end_src

#+RESULTS:
[[http://45.76.241.188][Public IP of this load balancer]]


* Overview
** OpenTofu
Manages clusters via Vultr provider

** Helmfile
Manages the K8s resources

* Current services
#+begin_src bash :results pp :exports results
for chart in helm/*/Chart.yaml; do
  yq '.name + " - " + .description' <"$chart"
done
#+end_src

#+RESULTS:
: nims-tofu-cloud - Hello World HTTP server in Nim


* How to run
1. Add your Vultr PAT at =.env=
2. Run
   #+begin_src bash
   make tofu-init tofu-plan tofu-apply helmfile-apply
   #+end_src
3. Done.


* Makefile targets
#+begin_src bash :results pp :exports both
make help
#+end_src

#+RESULTS:
#+begin_example
Current configs:
  ENV: dev
  ENV_FILE: ./.env
  INFRA_DIR: ./clusters
  INFRA_PLAN_FILE: plan.tfplan
  INFRA_TFSTATE_DIR: ./clusters/tfstates
  TOFU: tofu -chdir=./clusters
  KUBECONFIG_DEV: /home/user/.kube/config
  HELM_DIR: ./helm
  HELM: helm
  HELMFILE_YAML: ./helm/helmfile.yaml
  HELMFILE: helmfile -f ./helm/helmfile.yaml
  KUBECTL: kubectl
Dynamically obtained values:
  KUBECONFIG_PROD: /home/user/Documents/repos/infra/clusters/.kubeconfig
  KUBECONFIG_EFFECTIVE: /home/user/.kube/config

Available targets:
  Tofu targets:
    tofu-init                Initialize infrastructure
    tofu-plan                Plan infrastructure changes
    tofu-apply               Apply infrastructure changes
    tofu-refresh             Refresh infrastructure state
  Helm/helmfile targets:
    helmfile-apply           Runs apply command with kubeconfig set
    helmfile-diff            Runs diff helmfile command
    helmfile-destroy         Runs destroy helmfile command
    helmfile-sync            Runs sync helmfile command
    helm-test                Tests all charts
  KubeCTL targets:
    kubectl-loadBalancer-ip  Gets load balancer public IP
  Other targets:
    clean                    Clean up generated files
#+end_example


